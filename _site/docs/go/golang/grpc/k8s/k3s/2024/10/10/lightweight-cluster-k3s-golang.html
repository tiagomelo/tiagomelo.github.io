<p><img src="/assets/images/2024-10-10-lightweight-cluster-k3s-golang/banner.png" alt="banner" /></p>

<p><a href="https://kubernetes.io/">Kubernetes</a> is known for its ability to orchestrate complex, large-scale containerized applications. However, for smaller-scale projects or local development, the full <a href="https://kubernetes.io/">Kubernetes</a> stack can be overkill.</p>

<p>Meet <a href="https://k3s.io/https://k3s.io/">k3s</a> — a lightweight, production-grade <a href="https://kubernetes.io/">Kubernetes</a> distribution designed for resource-constrained environments.</p>

<p>In this article, I’ll walk you through setting up a <a href="https://k3s.io/https://k3s.io/">k3s</a> cluster and deploying a simple <a href="https://grpc.io/">gRPC</a> service using the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> project as an example.</p>

<h1 id="what-is-k3s">What is k3s?</h1>

<p><a href="https://k3s.io/https://k3s.io/">k3s</a> is a fully compliant Kubernetes distribution but is much lighter than its full <a href="https://kubernetes.io/">Kubernetes</a> counterpart.</p>

<p>It packages required dependencies such as <a href="https://github.com/flannel-io/flannel">Flannel</a>, <a href="https://traefik.io/traefik/">Traefik</a>, and <a href="https://github.com/k3s-io/klipper-lb">ServiceLB</a> into a single binary, making it ideal for edge computing, IoT, and small VPS environments. The key advantage is that it requires fewer resources while still providing the robust orchestration features of <a href="https://kubernetes.io/">Kubernetes</a>.</p>

<h2 id="step-1-installing-k3s">Step 1: Installing k3s</h2>

<p>To get started with <a href="https://k3s.io/https://k3s.io/">k3s</a>, you can install it on any Linux-based machine. For this example, I’m using a VPS, but the steps are similar for local setups or bare-metal installations.</p>

<h3 id="installation-command">Installation Command</h3>

<p>Run the following command on your machine or VPS to install <a href="https://k3s.io/https://k3s.io/">k3s</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sfL https://get.k3s.io | sh -
</code></pre></div></div>

<p>This command installs <a href="https://k3s.io/https://k3s.io/">k3s</a> and starts the <a href="https://kubernetes.io/">Kubernetes</a> control plane. By default, it uses <a href="https://containerd.io/">containerd</a> as the container runtime and <a href="https://github.com/flannel-io/flannel">Flannel</a> for networking.</p>

<p>Once <a href="https://k3s.io/https://k3s.io/">k3s</a> is installed, you can verify the status of your cluster:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl get nodes
NAME        STATUS   ROLES                  AGE   VERSION
srv613524   Ready    control-plane,master   9s    v1.30.5+k3s1
</code></pre></div></div>

<p>This will list the nodes in your <a href="https://k3s.io/https://k3s.io/">k3s</a> cluster. At this point, your lightweight <a href="https://kubernetes.io/">Kubernetes</a> environment is ready.</p>

<h2 id="step-2-deploying-a-grpc-service">Step 2: Deploying a gRPC Service</h2>

<p>Next, we will deploy the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> <a href="https://grpc.io/">gRPC</a> service to the <a href="https://k3s.io/https://k3s.io/">k3s</a> cluster. We’ll use two <a href="https://kubernetes.io/">Kubernetes</a> manifests: one for the <code class="language-plaintext highlighter-rouge">Deployment</code> and one for the <code class="language-plaintext highlighter-rouge">Service</code>.</p>

<h3 id="go-grpc-bin-deployment">go-grpc-bin deployment</h3>

<p>The <code class="language-plaintext highlighter-rouge">Deployment</code> manifest defines how the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> service will run. It specifies the container image, the number of replicas (1 in this case), and the container port.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-grpc-bin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: go-grpc-bin
  template:
    metadata:
      labels:
        app: go-grpc-bin
    spec:
      containers:
      - name: go-grpc-bin
        image: tiagoharris/go-grpc-bin:latest
        args: ["-p", "50051"]
        ports:
        - containerPort: 50051
apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-grpc-bin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: go-grpc-bin
  template:
    metadata:
      labels:
        app: go-grpc-bin
    spec:
      containers:
      - name: go-grpc-bin
        image: tiagoharris/go-grpc-bin:latest
        args: ["-p", "50051"]
        ports:
        - containerPort: 50051

</code></pre></div></div>

<p>Apply the Deployment:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl apply -f deployment.yaml 
deployment.apps/go-grpc-bin created
</code></pre></div></div>

<p>This will create a single instance (replica) of the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> service, running on port 50051.</p>

<p>Check if the deployment was successful:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl get deployments
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
go-grpc-bin   1/1     1            1           39s
</code></pre></div></div>

<h3 id="go-grpc-bin-service">go-grpc-bin Service</h3>

<p>Next, create a <code class="language-plaintext highlighter-rouge">Service</code> to expose the <a href="https://grpc.io/">gRPC</a> application. We’ll use a <code class="language-plaintext highlighter-rouge">LoadBalancer</code> service to assign an external IP so the service can be accessed outside the cluster.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Service
metadata:
  name: go-grpc-bin
spec:
  type: LoadBalancer
  selector:
    app: go-grpc-bin
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

</code></pre></div></div>

<p>Apply the Service manifest:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl apply -f service.yaml 
service/go-grpc-bin created
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">type: LoadBalancer</code> ensures that k3s’s built-in <a href="https://github.com/k3s-io/klipper-lb">ServiceLB</a> load-balancer controller assigns an external IP for your <a href="https://grpc.io/">gRPC</a> service. You can verify this by running:</p>

<p><img src="/assets/images/2024-10-10-lightweight-cluster-k3s-golang/svc.png" alt="svc" /></p>

<p>You should see an external IP assigned to the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> service.</p>

<h2 id="step-3-testing-the-grpc-service">Step 3: Testing the gRPC Service</h2>

<p>Once the deployment and service are running, you can test the <a href="https://grpc.io/">gRPC</a> service using <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a>, a command-line tool that allows you to interact with <a href="https://grpc.io/">gRPC</a> servers, similar to how <code class="language-plaintext highlighter-rouge">curl</code> interacts with HTTP services.</p>

<p>To test the service, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grpcurl -plaintext -d '{"message": "Hello, gRPC!"}' &lt;EXTERNAL-IP&gt;:50051 grpcbin.GRPCBin/Echo
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">&lt;EXTERNAL-IP&gt;</code> with the external IP assigned to the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> service.</p>

<p>Output you should see:</p>

<p><img src="/assets/images/2024-10-10-lightweight-cluster-k3s-golang/echo.png" alt="echo" /></p>

<h2 id="step-4-scaling-your-service-optional">Step 4: Scaling your service (optional)</h2>

<p>If you need more instances of the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> service, you can easily scale the deployment by modifying the replicas field in the deployment manifest or using the <code class="language-plaintext highlighter-rouge">kubectl scale</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl scale deployment go-grpc-bin --replicas=3
deployment.apps/go-grpc-bin scaled
</code></pre></div></div>

<p>Then we can see that we have 3 pods now:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl get pods
NAME                           READY   STATUS    RESTARTS   AGE
go-grpc-bin-7595547bf5-ckznw   1/1     Running   0          20m
go-grpc-bin-7595547bf5-s979z   1/1     Running   0          13s
go-grpc-bin-7595547bf5-zt22m   1/1     Running   0          13s
</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>

<p>In this article, we set up a lightweight <a href="https://kubernetes.io/">Kubernetes</a> cluster using <a href="https://k3s.io/https://k3s.io/">k3s</a> and deployed a <a href="https://grpc.io/">gRPC</a><a href="https://grpc.io/">gRPC</a> service using the <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> project. <a href="https://k3s.io/https://k3s.io/">k3s</a> offers a simple, resource-efficient way to run <a href="https://kubernetes.io/">Kubernetes</a> in environments where the full <a href="https://kubernetes.io/">Kubernetes</a> stack would be too heavy. With built-in components like <a href="https://github.com/k3s-io/klipper-lb">ServiceLB</a>, <a href="https://k3s.io/https://k3s.io/">k3s</a> provides an easy way to manage services and expose them to external clients.</p>

<p>If you’re looking for a lightweight <a href="https://kubernetes.io/">Kubernetes</a><a href="https://kubernetes.io/">Kubernetes</a> solution for edge, IoT, or small-scale applications, <a href="https://k3s.io/https://k3s.io/">k3s</a> is an excellent choice. By following the steps outlined above, you can have a fully functioning <a href="https://kubernetes.io/">Kubernetes</a> environment up and running with minimal effort.</p>
