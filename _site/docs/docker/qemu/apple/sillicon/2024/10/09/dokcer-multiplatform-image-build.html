<p><img src="/assets/images/2024-10-09-dokcer-multiplatform-image-build/banner.png" alt="banner" /></p>

<p>Building Docker images for multiple architectures, such as <code class="language-plaintext highlighter-rouge">amd64</code> and <code class="language-plaintext highlighter-rouge">arm64</code>, can be a challenge, especially when running on an Apple Silicon (M1/M2/M3) machine. However, with <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> and <a href="https://www.qemu.org/">QEMU</a>, it’s possible to create multi-platform images without much hassle. In this article, I’ll walk through how I resolved this challenge using my project <a href="https://github.com/tiagomelo/go-grpc-bin">go-grpc-bin</a> as an example.</p>

<p>You can find more details about <code class="language-plaintext highlighter-rouge">go-grpc-bin</code> in <a href="https://tiagomelo.info/go/grpc/2024/08/28/go-grpc-bin.html">my previous blog post</a> or in <a href="https://hub.docker.com/repository/docker/tiagoharris/go-grpc-bin/general">Docker Hub</a>.</p>

<h1 id="what-is-qemu">what is QEMU?</h1>

<p><a href="https://www.qemu.org/">QEMU</a> (Quick Emulator) is a powerful open-source emulator that enables Docker to build and run containers for architectures different from the host machine. For example, if you’re running Docker on an Apple Silicon Mac (<code class="language-plaintext highlighter-rouge">arm64</code>), <a href="https://www.qemu.org/">QEMU</a> allows you to build Docker images for the <code class="language-plaintext highlighter-rouge">amd64</code> architecture (used by Intel and AMD processors).</p>

<p>It provides dynamic translation of CPU instructions, enabling you to emulate the <code class="language-plaintext highlighter-rouge">amd64</code> architecture on an <code class="language-plaintext highlighter-rouge">arm64</code> machine. This makes it possible to create cross-platform <a href="https://www.docker.com">Docker</a> images using <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a>, ensuring that your containers can run on a wider range of platforms.</p>

<p>In the context of this project, <a href="https://www.qemu.org/">QEMU</a> was essential for allowing me to build the <a href="https://github.com/tiagomelo/go-grpc-bin"><code class="language-plaintext highlighter-rouge">go-grpc-bin</code></a> project for both <code class="language-plaintext highlighter-rouge">amd64</code> and <code class="language-plaintext highlighter-rouge">arm64</code> architectures from my Apple Silicon machine, without needing a separate <code class="language-plaintext highlighter-rouge">x86</code> machine.</p>

<h2 id="how-does-qemu-work-with-docker-buildx">how does QEMU work with Docker Buildx?</h2>

<p><a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> automatically uses <a href="https://www.qemu.org/">QEMU</a> when building for architectures that differ from the host. When you use the <code class="language-plaintext highlighter-rouge">--platform</code> flag with Buildx (for example, <code class="language-plaintext highlighter-rouge">--platform linux/amd64,linux/arm64</code>), <a href="https://www.docker.com">Docker</a> routes the build process through <a href="https://www.qemu.org/">QEMU</a>, translating instructions as needed for the target architecture.</p>

<p>This seamless integration allows developers to create multi-platform images with a single build command, ensuring broader compatibility for containerized applications.</p>

<h1 id="the-problem">the problem</h1>

<p>While attempting to build a multi-platform Docker image using Docker Buildx on my Apple Silicon machine, I encountered an error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosetta error: Rosetta is only intended to run on Apple Silicon with a macOS host using Virtualization.framework with Rosetta mode enabled
</code></pre></div></div>

<p>The error occurred when trying to build the image for the <code class="language-plaintext highlighter-rouge">amd64</code> architecture. <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> couldn’t handle the architecture mismatch, and Rosetta, which enables Intel (x86) applications to run on Apple Silicon, wasn’t configured for the build process.</p>

<h1 id="the-solution">the solution</h1>

<p>Here’s how I resolved the issue using <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a>, with a special focus on <a href="https://www.qemu.org/">QEMU</a> to handle cross-platform builds.</p>

<h2 id="step-1-install-rosetta">step 1: install Rosetta</h2>

<p>Since I was on an Apple Silicon Mac, I needed to make sure Rosetta 2 was installed. This is Apple’s compatibility layer that allows running amd64 binaries on <code class="language-plaintext highlighter-rouge">arm64</code> systems.</p>

<p>You can install <a href="https://support.apple.com/en-us/102527">Rosetta 2</a> with the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>softwareupdate --install-rosetta
</code></pre></div></div>

<h2 id="step-2-ensure-buildx-is-initialized">step 2: ensure Buildx is initialized</h2>

<p>Before building for multiple architectures, make sure <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> is initialized with proper platform support. Run the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker buildx create --use
docker buildx inspect --bootstrap
</code></pre></div></div>

<p>Ensure that <code class="language-plaintext highlighter-rouge">linux/amd64</code> and <code class="language-plaintext highlighter-rouge">linux/arm64</code> are listed under <code class="language-plaintext highlighter-rouge">Platforms</code> in the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker buildx inspect --bootstrap
[+] Building 1.8s (1/1) FINISHED                                                                                                                                            
 =&gt; [internal] booting buildkit                                                                                                                                        1.8s
 =&gt; =&gt; pulling image moby/buildkit:buildx-stable-1                                                                                                                     1.6s
 =&gt; =&gt; creating container buildx_buildkit_gallant_carson0                                                                                                              0.2s
Name:          gallant_carson
Driver:        docker-container
Last Activity: 2024-10-09 13:00:41 +0000 UTC

Nodes:
Name:                  gallant_carson0
Endpoint:              desktop-linux
Status:                running
BuildKit daemon flags: --allow-insecure-entitlement=network.host
BuildKit version:      v0.16.0
Platforms:             linux/arm64, linux/amd64, linux/amd64/v2, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6

...
</code></pre></div></div>

<h2 id="step-3-build-and-push-multi-platform-image">step 3: build and push multi-platform image</h2>

<p>With <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> and <a href="https://www.qemu.org/">QEMU</a> working properly, the final step was to build and push the <a href="https://www.docker.com">Docker</a> image for multiple architectures:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker buildx build --platform linux/amd64,linux/arm64 -t tiagoharris/go-grpc-bin:latest --push .
</code></pre></div></div>

<p>This command builds the image for both platforms and pushes it to <a href="https://hub.docker.com">Docker Hub</a>. Now, the image is available for use on both amd64 and arm64 machines, making it highly flexible for deployments on different hardware architectures:</p>

<p><img src="/assets/images/2024-10-09-dokcer-multiplatform-image-build/dockerhub.png" alt="docker hub" /></p>

<h1 id="conclusion">conclusion</h1>

<p>With just a few steps, you can easily build and push multi-platform Docker images from an Apple Silicon machine using <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> and <a href="https://www.qemu.org/">QEMU</a>. This setup allows you to create images compatible with both amd64 (Intel/AMD) and arm64 (Apple Silicon) systems, ensuring your applications can be deployed on a wider range of environments.</p>

<p>By leveraging the power of <a href="https://docs.docker.com/reference/cli/docker/buildx/">Docker Buildx</a> and <a href="https://www.qemu.org/">QEMU</a>, cross-platform development becomes much simpler, especially when working with cloud-native applications or microservices that need to run on various architectures.</p>
